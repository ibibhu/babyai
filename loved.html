<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Loved Names ‚Äî Amritha & Bikram's Baby Boy</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <!-- Firebase CDN -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>

    <!-- Shared init + Google Auth (replaces all firebase config in each file) -->
    <script src="firebase-init.js"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:ital,wght@0,400;0,600;0,700;1,400&family=Nunito:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg:          #0c0a18;
      --border-warm: rgba(255,185,200,0.28);
      --text:        #f5f0ff;
      --muted:       rgba(210,200,255,0.42);
      --accent:      #ffb7c5;
      --accent2:     #bfb0f8;
      --like:        #7de8be;
      --radius:      20px;
      --font-display: 'Cormorant Garamond', Georgia, serif;
      --font-body:    'Nunito', sans-serif;
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: var(--font-body);
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
      display: flex; flex-direction: column; align-items: center;
      padding: 28px 16px 60px;
      overflow-x: hidden;
    }
    body::before {
      content: '';
      position: fixed; inset: 0; z-index: 0; pointer-events: none;
      background:
        radial-gradient(ellipse 70% 55% at 15% 8%,   rgba(110,70,210,0.28) 0%, transparent 65%),
        radial-gradient(ellipse 55% 45% at 85% 75%,  rgba(255,120,170,0.16) 0%, transparent 60%),
        radial-gradient(ellipse 45% 35% at 70% 15%,  rgba(70,90,220,0.13)  0%, transparent 55%),
        #0c0a18;
    }
    .star {
      position: fixed; border-radius: 50%; background: white;
      pointer-events: none; z-index: 0;
      animation: twinkle var(--dur, 3s) var(--delay, 0s) ease-in-out infinite;
    }
    @keyframes twinkle {
      0%, 100% { opacity: 0.15; transform: scale(0.7); }
      50%       { opacity: 0.9;  transform: scale(1.3); }
    }
    .wrap {
      position: relative; z-index: 1;
      width: 100%; max-width: 480px;
      display: flex; flex-direction: column; align-items: center;
      gap: 18px;
    }

    /* Header */
    header { text-align: center; padding-top: 16px; animation: fadeDown 0.6s ease both; }
    .heart-emoji {
      display: block; font-size: 56px; line-height: 1; margin-bottom: 12px;
      filter: drop-shadow(0 0 22px rgba(255,183,197,0.7));
      animation: pulse 2.5s ease-in-out infinite;
    }
    @keyframes pulse {
      0%, 100% { transform: scale(1);    filter: drop-shadow(0 0 18px rgba(255,183,197,0.6)); }
      50%       { transform: scale(1.1); filter: drop-shadow(0 0 30px rgba(255,183,197,0.9)); }
    }
    header h1 {
      font-family: var(--font-display);
      font-size: 30px; font-weight: 700; line-height: 1.25;
      background: linear-gradient(140deg, #fff 10%, var(--accent) 55%, var(--accent2) 100%);
      -webkit-background-clip: text; -webkit-text-fill-color: transparent;
      background-clip: text;
    }
    header p { font-size: 10px; color: var(--muted); margin-top: 7px; letter-spacing: 2.5px; text-transform: uppercase; }
    @keyframes fadeDown {
      from { opacity: 0; transform: translateY(-14px); }
      to   { opacity: 1; transform: translateY(0); }
    }

    /* Stat row */
    .stats {
      display: flex; gap: 12px; width: 100%;
      animation: fadeUp 0.5s 0.1s ease both;
    }
    .stat-card {
      flex: 1; text-align: center;
      background: rgba(255,255,255,0.04);
      backdrop-filter: blur(16px); -webkit-backdrop-filter: blur(16px);
      border: 1px solid rgba(255,255,255,0.09);
      border-radius: 14px; padding: 16px 10px;
    }
    .stat-card .num {
      font-family: var(--font-display);
      font-size: 36px; font-weight: 700; line-height: 1;
      background: linear-gradient(135deg, var(--accent), var(--accent2));
      -webkit-background-clip: text; -webkit-text-fill-color: transparent;
      background-clip: text;
    }
    .stat-card .lbl { font-size: 10px; color: var(--muted); letter-spacing: 1.5px; text-transform: uppercase; margin-top: 4px; }

    /* Section cards */
    .section {
      width: 100%;
      background: rgba(255,255,255,0.038);
      backdrop-filter: blur(24px); -webkit-backdrop-filter: blur(24px);
      border: 1px solid var(--border-warm);
      border-radius: var(--radius); padding: 24px;
      position: relative; overflow: hidden;
      animation: fadeUp 0.55s ease both;
    }
    .section::before {
      content: '';
      position: absolute; top: 0; left: 0; right: 0; height: 1px;
      background: linear-gradient(90deg, transparent, var(--accent) 35%, var(--accent2) 65%, transparent);
      opacity: 0.6;
    }
    .section:nth-of-type(1) { animation-delay: 0.10s; }
    .section:nth-of-type(2) { animation-delay: 0.18s; }
    .section:nth-of-type(3) { animation-delay: 0.26s; }

    .section h2 {
      font-family: var(--font-display);
      font-size: 20px; font-weight: 600; letter-spacing: 0.3px;
      margin-bottom: 18px;
      background: linear-gradient(120deg, var(--accent2), var(--accent));
      -webkit-background-clip: text; -webkit-text-fill-color: transparent;
      background-clip: text;
    }
    @keyframes fadeUp {
      from { opacity: 0; transform: translateY(16px); }
      to   { opacity: 1; transform: translateY(0); }
    }

    /* Loved name cards */
    .names-grid {
      display: flex; flex-direction: column; gap: 8px;
    }
    .name-card {
      display: flex; align-items: center; gap: 14px;
      padding: 14px 16px; border-radius: 14px;
      background: rgba(255,255,255,0.04);
      border: 1px solid rgba(125,232,190,0.15);
      transition: background 0.15s, transform 0.15s;
      animation: popIn 0.4s ease both;
    }
    .name-card:hover { background: rgba(255,255,255,0.07); transform: translateX(4px); }
    @keyframes popIn {
      from { opacity: 0; transform: scale(0.96); }
      to   { opacity: 1; transform: scale(1); }
    }
    .name-card .heart { font-size: 18px; flex-shrink: 0; }
    .name-card .info  { flex: 1; }
    .name-card .name  {
      font-family: var(--font-display);
      font-size: 22px; font-weight: 700; line-height: 1.1;
      background: linear-gradient(120deg, #fff 30%, var(--accent));
      -webkit-background-clip: text; -webkit-text-fill-color: transparent;
      background-clip: text;
    }
    .name-card .by    { font-size: 11px; color: var(--muted); margin-top: 2px; letter-spacing: 0.3px; }
    .name-card .by span { color: var(--accent); }

    /* Leaderboard */
    .leader-item {
      display: flex; align-items: center;
      padding: 12px 14px; border-radius: 13px;
      background: rgba(255,255,255,0.04);
      border: 1px solid rgba(255,255,255,0.07);
      gap: 12px; margin-bottom: 6px;
      transition: background 0.15s;
    }
    .leader-item.gold   { background: linear-gradient(135deg, rgba(255,210,100,0.12), rgba(255,183,197,0.08)); border-color: rgba(255,210,100,0.28); }
    .leader-item.silver { background: linear-gradient(135deg, rgba(200,200,220,0.10), rgba(191,176,248,0.07)); border-color: rgba(200,200,220,0.22); }
    .leader-item.bronze { background: linear-gradient(135deg, rgba(200,150,100,0.10), rgba(255,183,197,0.06)); border-color: rgba(200,150,100,0.22); }

    .medal  { font-size: 20px; flex-shrink: 0; width: 28px; text-align: center; }
    .l-name { flex: 1; font-weight: 600; font-size: 14px; }
    .l-score {
      font-family: var(--font-display);
      font-size: 26px; font-weight: 700;
      color: var(--accent);
    }
    .l-names-list { font-size: 11px; color: var(--muted); margin-top: 2px; }

    /* Empty state */
    .empty {
      text-align: center; padding: 32px 16px; color: var(--muted);
      font-size: 14px; line-height: 1.7;
    }
    .empty .big { font-size: 40px; margin-bottom: 10px; }

    /* Sync + nav */
    #syncStatus { font-size: 10px; color: var(--muted); letter-spacing: 0.5px; align-self: flex-end; margin-top: -10px; }
    .nav {
      display: flex; gap: 10px; width: 100%;
      animation: fadeUp 0.5s 0.3s ease both;
    }
    .nav a {
      flex: 1; padding: 12px; border-radius: 12px; text-align: center;
      font-family: var(--font-body); font-size: 13px; font-weight: 700;
      text-decoration: none; letter-spacing: 0.3px;
      transition: transform 0.12s, box-shadow 0.2s, background 0.15s;
    }
    .nav a:hover { transform: translateY(-2px); }
    .nav-main {
      background: linear-gradient(135deg, rgba(255,183,197,0.13), rgba(191,176,248,0.13));
      color: var(--accent);
      border: 1px solid rgba(255,183,197,0.28);
    }
    .nav-main:hover { box-shadow: 0 8px 24px rgba(255,183,197,0.15); }
    .nav-reset {
      background: rgba(255,255,255,0.04);
      color: var(--muted);
      border: 1px solid rgba(255,255,255,0.09);
    }
    .nav-reset:hover { background: rgba(255,255,255,0.08); color: var(--text); }
  </style>
</head>
<body>

<div class="wrap">

  <header>
    <span class="heart-emoji">üíù</span>
    <h1>Loved Names</h1>
    <p>Amritha & Bikram's Baby Boy</p>
  </header>

  <div id="syncStatus">Connecting‚Ä¶</div>

  <!-- Stat pills -->
  <div class="stats">
    <div class="stat-card">
      <div class="num" id="statLoved">‚Äî</div>
      <div class="lbl">Loved</div>
    </div>
    <div class="stat-card">
      <div class="num" id="statTotal">‚Äî</div>
      <div class="lbl">Total names</div>
    </div>
    <div class="stat-card">
      <div class="num" id="statSwiped">‚Äî</div>
      <div class="lbl">Reviewed</div>
    </div>
  </div>

  <!-- Loved names list -->
  <div class="section" id="lovedSection">
    <h2>‚ô• Names everyone loves</h2>
    <div class="names-grid" id="namesList">
      <div class="empty"><div class="big">‚è≥</div>Loading‚Ä¶</div>
    </div>
  </div>

  <!-- Leaderboard -->
  <div class="section" id="leaderSection">
    <h2>üèÜ Top suggesters</h2>
    <div id="leaderList">
      <div class="empty"><div class="big">‚è≥</div>Loading‚Ä¶</div>
    </div>
  </div>

  <!-- Nav -->
  <div class="nav">
    <a class="nav-main" href="index.html">‚Üê Back to voting</a>
    <a class="nav-reset" href="reset.html">Reset votes</a>
  </div>

</div>

<!-- Stars -->
<script>
  (function() {
    for (let i = 0; i < 45; i++) {
      const s = document.createElement('div');
      s.className = 'star';
      const size = Math.random() * 2 + 1;
      s.style.cssText = `width:${size}px;height:${size}px;top:${Math.random()*100}vh;left:${Math.random()*100}vw;--dur:${(Math.random()*3+2).toFixed(1)}s;--delay:-${(Math.random()*4).toFixed(1)}s;`;
      document.body.appendChild(s);
    }
  })();
</script>

<script>
  // Robust doc ref getter (works if firebase-init exposes `docRef` or `fireDb`)
  function DOC_REF() {
    if (typeof window === 'undefined') return null;
    if (window.docRef) return window.docRef;
    if (window.fireDb) return window.fireDb.collection('babyNames').doc('state');
    return null;
  }

  const docRef = DOC_REF();
  if (!docRef) {
    setSyncStatus('‚ö† Firestore not initialised');
    console.error('loved.html: cannot find Firestore docRef');
  }

  function setSyncStatus(msg) { document.getElementById('syncStatus').textContent = msg; }

  const MEDALS = ['ü•á', 'ü•à', 'ü•â'];

  function render(names) {
    // Normalize items and support both legacy booleans and new per-user arrays
    const norm = names.map(item => {
      const copy = Object.assign({}, item);
      if (!Array.isArray(copy.likedBy)) copy.likedBy = copy.liked ? ['<legacy>'] : [];
      if (!Array.isArray(copy.swipedBy)) copy.swipedBy = copy.swiped ? ['<legacy>'] : [];
      return copy;
    });

    const loved   = norm.filter(n => Array.isArray(n.likedBy) && n.likedBy.length > 0);
    const swiped  = norm.filter(n => Array.isArray(n.swipedBy) && n.swipedBy.length > 0).length;

    // Stats
    document.getElementById('statLoved').textContent  = loved.length;
    document.getElementById('statTotal').textContent  = names.length;
    document.getElementById('statSwiped').textContent = swiped;

    // Loved names list
    const grid = document.getElementById('namesList');
    grid.innerHTML = '';
    // Determine top (winning) name(s)
    let topCount = 0;
    norm.forEach(it => { const c = Array.isArray(it.likedBy) ? it.likedBy.length : 0; if (c > topCount) topCount = c; });
    const winners = norm.filter(it => (Array.isArray(it.likedBy) ? it.likedBy.length : 0) === topCount && topCount > 0);

    if (!loved.length) {
      grid.innerHTML = `<div class="empty"><div class="big">ü§ç</div>No loved names yet.<br>Start swiping to add some!</div>`;
    } else {
      loved.forEach((item, i) => {
        const div = document.createElement('div');
        div.className = 'name-card';
        div.style.animationDelay = `${i * 0.05}s`;
        // Voters: support objects with `displayName` or plain strings (uids)
        const voters = Array.isArray(item.likedBy) ? item.likedBy.map(v => {
          if (!v) return '';
          if (typeof v === 'object') return v.displayName || v.name || (v.uid || '').slice(0,6);
          return (typeof v === 'string' && v.length > 10) ? v.slice(0,6) : v;
        }).filter(Boolean) : [];
        const votersLine = voters.length ? `<div class="by">voted by <span>${voters.join(', ')}</span> ¬∑ ${voters.length} vote${voters.length>1?'s':''}</div>` : '';

        // Highlight winner(s)
        const isWinner = (Array.isArray(item.likedBy) ? item.likedBy.length : 0) === topCount && topCount > 0;
        div.innerHTML = `
          <span class="heart">${isWinner ? 'üèÜ' : '‚ô•'}</span>
          <div class="info">
            <div class="name">${item.name}${isWinner ? ' ‚Äî winning' : ''}</div>
            <div class="by">suggested by <span>${item.suggestedBy}</span></div>
            ${votersLine}
          </div>`;
        grid.appendChild(div);
      });
    }

    // If there's a clear single winner, show a small banner above the section
    const lovedSection = document.getElementById('lovedSection');
    const existingBanner = document.getElementById('winnerBanner');
    if (existingBanner) existingBanner.remove();
    if (winners && winners.length === 1) {
      const b = document.createElement('div');
      b.id = 'winnerBanner';
      b.style.cssText = 'margin-bottom:8px;padding:10px;border-radius:10px;background:linear-gradient(90deg,rgba(255,210,100,0.08),rgba(255,183,197,0.04));border:1px solid rgba(255,210,100,0.12);font-weight:700;text-align:center;';
      b.textContent = `Current leader: ${winners[0].name} ‚Äî ${topCount} vote${topCount>1?'s':''}`;
      lovedSection.insertBefore(b, lovedSection.firstChild);
    }

    // Leaderboard
    const scores = {};
    const likedByPerson = {};
    for (const item of norm) {
      const count = Array.isArray(item.likedBy) ? item.likedBy.length : (item.liked ? 1 : 0);
      if (count) {
        scores[item.suggestedBy] = (scores[item.suggestedBy] || 0) + count;
        if (!likedByPerson[item.suggestedBy]) likedByPerson[item.suggestedBy] = [];
        likedByPerson[item.suggestedBy].push(item.name + (count>1?` (${count})`:''));
      }
    }

    const entries = Object.entries(scores).sort((a, b) => b[1] - a[1]);
    const leaderList = document.getElementById('leaderList');
    leaderList.innerHTML = '';

    if (!entries.length) {
      leaderList.innerHTML = `<div class="empty"><div class="big">üèÜ</div>No votes yet.<br>Start swiping!</div>`;
    } else {
      entries.forEach(([person, score], i) => {
        const tierClass = i === 0 ? 'gold' : i === 1 ? 'silver' : i === 2 ? 'bronze' : '';
        const medal     = MEDALS[i] || `${i + 1}.`;
        const namesList = (likedByPerson[person] || []).join(', ');
        const div = document.createElement('div');
        div.className = `leader-item ${tierClass}`;
        div.innerHTML = `
          <span class="medal">${medal}</span>
          <div style="flex:1">
            <div class="l-name">${person}</div>
            <div class="l-names-list">${namesList}</div>
          </div>
          <span class="l-score">${score}</span>`;
        leaderList.appendChild(div);
      });
    }
  }

  // Init + live updates
  setSyncStatus('Connecting‚Ä¶');
  if (docRef) {
    docRef.onSnapshot(
      (snap) => {
        console.debug('loved.html: snapshot', snap && snap.data && snap.data());
        if (snap.exists && Array.isArray(snap.data().names)) {
          setSyncStatus('‚úì Live');
          render(snap.data().names);
        } else {
          setSyncStatus('No data yet');
          console.warn('loved.html: snapshot exists but no names array', snap && snap.data && snap.data());
        }
      },
      (err) => {
        setSyncStatus('‚ö† ' + err.message);
        console.error(err);
      }
    );
  }
</script>
</body>
</html>